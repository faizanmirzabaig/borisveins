(function(g){g.fn.gMap=function(e,o){switch(e){case"addMarker":return g(this).trigger("gMap.addMarker",[o.latitude,o.longitude,o.content,o.icon,o.popup]);case"centerAt":return g(this).trigger("gMap.centerAt",[o.latitude,o.longitude,o.zoom]);case"clearMarkers":return g(this).trigger("gMap.clearMarkers")}var w=g.extend({},g.fn.gMap.defaults,e);return this.each(function(){var c=new google.maps.Map(this);g(this).data("gMap.reference",c);var e=new google.maps.Geocoder;if(w.address){e.geocode({address:w.address},function(e,o){if(e&&e.length){c.setCenter(e[0].geometry.location)}})}else{if(w.latitude&&w.longitude){c.setCenter(new google.maps.LatLng(w.latitude,w.longitude))}else{if(g.isArray(w.markers)&&w.markers.length>0){if(w.markers[0].address){e.geocode({address:w.markers[0].address},function(e,o){if(e&&e.length>0){c.setCenter(e[0].geometry.location)}})}else{c.setCenter(new google.maps.LatLng(w.markers[0].latitude,w.markers[0].longitude))}}else{c.setCenter(new google.maps.LatLng(34.885931,9.84375))}}}c.setZoom(w.zoom);c.setMapTypeId(google.maps.MapTypeId[w.maptype]);var o={scrollwheel:w.scrollwheel,disableDoubleClickZoom:!w.doubleclickzoom};if(w.controls===false){g.extend(o,{disableDefaultUI:true})}else if(w.controls.length!==0){g.extend(o,w.controls,{disableDefaultUI:true})}c.setOptions(o);var p=new google.maps.Marker;var a;var n;a=new google.maps.MarkerImage(w.icon.image);a.size=new google.maps.Size(w.icon.iconsize[0],w.icon.iconsize[1]);a.anchor=new google.maps.Point(w.icon.iconanchor[0],w.icon.iconanchor[1]);p.setIcon(a);if(w.icon.shadow){n=new google.maps.MarkerImage(w.icon.shadow);n.size=new google.maps.Size(w.icon.shadowsize[0],w.icon.shadowsize[1]);n.anchor=new google.maps.Point(w.icon.shadowanchor[0],w.icon.shadowanchor[1]);p.setShadow(n)}g(this).bind("gMap.centerAt",function(e,o,a,n){if(n){c.setZoom(n)}c.panTo(new google.maps.LatLng(parseFloat(o),parseFloat(a)))});var m=[];g(this).bind("gMap.clearMarkers",function(){while(m[0]){m.pop().setMap(null)}});var h;g(this).bind("gMap.addMarker",function(d,e,o,a,n,s){var r;var t;var i=new google.maps.LatLng(parseFloat(e),parseFloat(o));var g=new google.maps.Marker({position:i});if(n){r=new google.maps.MarkerImage(n.image);r.size=new google.maps.Size(n.iconsize[0],n.iconsize[1]);r.anchor=new google.maps.Point(n.iconanchor[0],n.iconanchor[1]);g.setIcon(r);if(n.shadow){t=new google.maps.MarkerImage(n.shadow);t.size=new google.maps.Size(n.shadowsize[0],n.shadowsize[1]);t.anchor=new google.maps.Point(n.shadowanchor[0],n.shadowanchor[1]);p.setShadow(t)}}else{g.setIcon(p.getIcon());g.setShadow(p.getShadow())}if(a){if(a==="_latlng"){a=e+", "+o}var l=new google.maps.InfoWindow({content:w.html_prepend+a+w.html_append});google.maps.event.addListener(g,"click",function(){if(h){h.close()}l.open(c,g);h=l});if(s){google.maps.event.addListenerOnce(c,"tilesloaded",function(){l.open(c,g)})}}g.setMap(c);m.push(g)});var s;var t=this;var i=function(a){return function(e,o){if(e&&e.length>0){g(t).trigger("gMap.addMarker",[e[0].geometry.location.lat(),e[0].geometry.location.lng(),a.html,a.icon,a.popup])}}};for(var r=0;r<w.markers.length;r++){s=w.markers[r];if(s.address){if(s.html==="_address"){s.html=s.address}e.geocode({address:s.address},i(s))}else{g(this).trigger("gMap.addMarker",[s.latitude,s.longitude,s.html,s.icon,s.popup])}}})};g.fn.gMap.defaults={address:"",latitude:0,longitude:0,zoom:1,markers:[],controls:[],scrollwheel:false,doubleclickzoom:true,maptype:"ROADMAP",html_prepend:'<div class="gmap_marker">',html_append:"</div>",icon:{image:"http://www.google.com/mapfiles/marker.png",shadow:"http://www.google.com/mapfiles/shadow50.png",iconsize:[20,34],shadowsize:[37,34],iconanchor:[9,34],shadowanchor:[6,34]}}})(jQuery);